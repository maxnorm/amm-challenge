# Sapient Strategy Audit: Plateau at 380 vs Top Score 526

**Date:** 2025-02-09  
**Context:** Sapient V7 edge ~380.14; V8 (full YQ-inspired stack) regressed to 378.99. Top score ~526 (YQ ~520).  
**Goal:** Diagnose why we plateau, whether we need big structural changes, and what to do next — with online research and amm-fee-designer workflow.

---

## Executive Summary

- **Gap:** ~146 points (380 → 526). YQ and the leader sit at ~520+.
- **V8 lesson:** Adding cap 85, stale+attract, and dirState **reduced** edge. So either tuning is wrong or the sim mix doesn’t reward those levers as implemented.
- **Research:** Optimal dynamic fees use two regimes (high to deter arb, low to attract noise); **linear-in-inventory fees sensitive to external price** approximate optimal; **threshold-type** schedules (normal = competitive, high vol = elevated) are robust.
- **Verdict:** We likely need **at least one structural change** (activity/flow in base, tail compression, or first-in-step logic) plus careful tuning. Parameter-only tweaks are unlikely to close a 146-point gap.

---

## Step 1 — Loss Diagnosis (Why We’re Stuck at ~380)

### What we already have (V7/V8)

- Base fee with vol and imbalance (K_VOL, K_IMB), floor, decay.
- Symmetric toxicity (linear + quad + SYM_HIGH above 1.5%).
- Asymmetric tox premium on vulnerable side (linear + quad + sigma×tox + cubic).
- Directionality (dir only when ret ≤ gate), scaled surge (15–40 bps), trade-size bump (up to 20 bps).
- V8 adds: pImplied for pHat/ret, trade-aligned boost, stale+attract, dirState, time-consistent decay, cap 85 bps.

### Mechanical reasons we’re still stuck

1. **V8 regression (378.99 vs 380.14)**  
   Cap 85, stale+attract, and/or dirState skew are hurting in our harness. V9 zeros those to isolate the cause. Until we know which lever is harmful, we’re not sure the “more like YQ” direction is correct **at our current tuning**.

2. **No activity/flow in base fee**  
   We charge by **current** trade size (bump) but not by **how busy** the market is. YQ uses **lambdaHat** (trades per step), **sizeHat** (smoothed trade size), and **actEma**, and puts LAMBDA_COEF, FLOW_SIZE_COEF, ACT_COEF into base/mid. In high-activity regimes we undercharge relative to YQ.

3. **Hard cap vs tail compression**  
   We use a single hard cap (75 or 85 bps). YQ uses **tail compression**: above a knee (e.g. 5 bps), fee is knee + slope × (fee − knee), with different slopes for protect vs attract, then clamp. That preserves gradient information and can score better when the sim rewards “softer” high-fee behavior.

4. **Base fee structure differs from YQ**  
   We use BASE_FEE = 35 bps and multiply by (1 + K_VOL×vol)(1 + K_IMB×imb), then add sym-tox and floor. YQ uses BASE_FEE = **3 bps** and adds sigma, lambda, flowSize, then tox + act in mid. So we start high and add; they start very low and build. That changes how retail vs arb are balanced across regimes.

5. **pHat/sigma update every trade**  
   YQ updates pHat with **two alphas**: fast (PHAT_ALPHA) for **first-in-step**, slow (PHAT_ALPHA_RETAIL) for later trades in the same step, and updates **sigmaHat only on first-in-step**. We use one alpha and update sigma every trade. So we’re noisier in multi-trade steps and may lag or overreact differently.

6. **Possible over-charging in calm regimes**  
   Our 35 bps base + vol×imb can already be high when vol/imb are modest. If the sim routes retail to the 30 bps normalizer when we’re a bit above, we lose volume without gaining proportionally from arb. YQ’s 3 bps base keeps them competitive in calm regimes.

**Summary:** The main structural gaps are: **(a)** no lambda/size/activity terms in base, **(b)** hard cap instead of tail compression, **(c)** single alpha and every-trade sigma update vs first-in-step logic, **(d)** high base (35 bps) vs YQ’s 3 bps build-up. The V8 regression suggests our **implementation/tuning** of cap 85, stale+attract, and dirState may be off, not necessarily the concepts.

---

## Step 2 — Adversarial Exploitation

1. **Cap arbitrage**  
   When true fee would be above our cap, we output the cap. Arb’s profit on those trades is larger than we’ve priced; we leave margin on the table. Tail compression (like YQ) could reduce this.

2. **Fade surge / dirState**  
   After we add surge or dirState skew to one side, the next trade on the **other** side sees lower fee. Arb can trade the reversion at a discount. If dirState/stale are mis-tuned (as V8 suggests), this fade is easier.

3. **Activity timing**  
   We don’t charge for “how many trades per step.” In bursts of arb, we charge per trade but not for intensity. So high-activity toxic flow is under-priced relative to YQ.

4. **Retail routing**  
   If our base is often above 30 bps in calm regimes, retail prefers the normalizer. We only get flow when we’re already stressed (higher vol/imb), which can be more toxic on average → adverse selection.

5. **First-trade-in-step**  
   We update pHat and sigma on every trade. A bot that trades repeatedly in the same step sees us update our “fair price” and volatility on each hit, which can be exploited (e.g. move us then fade).

---

## Step 3 — Failure Modes

| Regime / condition        | Current limitation                         | Effect |
|---------------------------|--------------------------------------------|--------|
| High activity (many trades/step) | No lambdaHat/sizeHat/actEma in fee       | Undercharge vs YQ; arb bursts cheap |
| Calm, low vol/imb         | Base 35 bps + factors can exceed 30 bps   | Retail routes away; we see less benign flow |
| Near cap (75/85 bps)       | Hard clip                                  | Marginal value of surge/size/dir lost |
| Multi-trade steps         | Same pHat/sigma update for all trades      | Noisier and more exploitable than first-in-step logic |
| Post–surge / post–dirState | Reversion on other side                    | Lower fee on the reversion trade |

---

## Step 4 — Online Research Summary

### Optimal dynamic fees (Baggiani et al., arXiv 2506.02869)

- **Two regimes:** (1) **High fees** to deter arbitrageurs, (2) **Low fees** to increase volatility and attract noise traders.
- **Good approximation:** Dynamic fees that are **linear in inventory** and **sensitive to external price changes** approximate the optimal fee structure.
- **Implication:** Our imbalance term (K_IMB) and vol/pHat sensitivity are in the right direction; we may still be missing a clean “inventory linear” component and a clearer regime switch (low vs high vol).

### Threshold-type schedules (literature)

- Under **normal** conditions, optimal fees stay **competitive with CEX** (stable, not high).
- In **high volatility**, **elevated fees** protect LPs from severe losses.
- **Takeaway:** Our base might be too high in “normal” (hurting retail share); we may need a lower floor and steeper response only when vol/tox cross a threshold.

### LVR and fee–arb relationship

- **LVR** is the main adverse selection cost (arb trades at better-than-fair).
- Fees **rescale** arb profits: they roughly equal frictionless LVR scaled by how often mispricing exceeds the fee threshold.
- **Implication:** Raising fees where we’re wrong (tox, sigma×tox, surge) is right; we need to do it without over-raising in calm regimes (retail loss).

### YQ vs Sapient (structural)

- **YQ:** 3 bps base; sigma + lambda + flowSize in base; tox + act in mid; sigma×tox, cubic tox; dirState skew; stale+attract; **tail compression**; **first-in-step** pHat/sigma; **lambdaHat, sizeHat, actEma**.
- **Sapient:** 35 bps base; vol×imb base; sym-tox + vulnerable-side tox (incl. sigma×tox, cubic); dir, surge, size bump; pImplied; trade boost; stale+attract; dirState; **hard cap**; **single alpha, sigma every trade**; **no lambda/size/activity state**.

---

## Step 5 — New Strategy Ideas (To Close the Gap)

### A. Activity/flow in base (structural)

- **Idea:** Add **lambdaHat** (trades per step), **sizeHat** (smoothed trade size), and optionally **actEma**. Fee terms: LAMBDA_COEF×lambdaHat, FLOW_SIZE_COEF×lambdaHat×sizeHat, ACT_COEF×actEma (or a subset).
- **Addresses:** High-activity under-pricing; aligns with YQ and “sensitivity to flow.”
- **Slots:** 2–3 (lambdaHat, stepTradeCount, sizeHat; actEma can share or add one).
- **Risk:** More state and constants; need to stay within slot budget and avoid stack issues.

### B. Tail compression instead of hard cap (structural)

- **Idea:** Replace hard cap with: above TAIL_KNEE (e.g. 5 bps), fee = knee + slope×(fee − knee); different slopes for protect vs attract; then clamp to MAX_FEE.
- **Addresses:** Cap clipping; preserves marginal information; matches YQ.
- **Risk:** More logic; slope tuning critical.

### C. First-in-step pHat/sigma (structural)

- **Idea:** Use **stepTradeCount** (or “first in step” flag). On first trade in step: use PHAT_ALPHA (e.g. 0.26), update sigmaHat. On subsequent trades in same step: use PHAT_ALPHA_RETAIL (e.g. 0.05), do not update sigmaHat.
- **Addresses:** Noisy multi-trade steps; exploitation of every-trade updates.
- **Risk:** Requires step boundary (we have timestamp); need to define “step” (e.g. timestamp change).

### D. Lower base, build up (structural)

- **Idea:** Lower BASE_FEE (e.g. toward 5–15 bps) and add sigma/vol and imbalance as **additive** terms (like YQ) rather than multiplicative. Tune so calm-regime fee is closer to 30 bps to compete for retail.
- **Addresses:** Retail routing in calm regimes; threshold-type behavior (low base, high when vol/tox).
- **Risk:** Large change; full re-tune of coefficients.

### E. Tune V8 levers in isolation (non-structural)

- **Idea:** V9 already tests cap 75 + no stale + no dirState skew. Then re-enable one at a time: e.g. cap 85 only; or dirState only; or stale+attract only. Measure edge each time.
- **Addresses:** V8 regression; find which lever is mis-tuned or wrong for the sim.
- **Risk:** May only recover to ~380, not reach 400+.

### F. Imbalance-linear fee (research-aligned)

- **Idea:** Add an explicit **linear-in-inventory** term (e.g. fee += K_IMB_LIN × |reserveY/reserveX − target| or similar in WAD). Keep it simple and bounded.
- **Addresses:** Research result that linear-in-inventory fees approximate optimal.
- **Risk:** Redundant with current imbalance factor; need to avoid double-counting.

---

## Step 6 — Formulas & Pseudocode

### A. Activity/flow (minimal)

```text
// Slots: lambdaHat, stepTradeCount, sizeHat (and timestamp for step)
// On new step (timestamp > lastTs):
//   elapsed = min(timestamp - lastTs, ELAPSED_CAP)
//   if stepTradeCount > 0 && elapsed > 0:
//     lambdaInst = (stepTradeCount * WAD) / elapsed; cap at LAMBDA_CAP
//     lambdaHat = LAMBDA_DECAY*lambdaHat + (1-LAMBDA_DECAY)*lambdaInst
//   sizeHat = sizeHat * SIZE_DECAY^elapsed
//   stepTradeCount = 0
// On every trade:
//   if tradeRatio > SIGNAL_THRESHOLD:
//     sizeHat = SIZE_BLEND*sizeHat + (1-SIZE_BLEND)*tradeRatio; cap at WAD
//   stepTradeCount++
// Base fee:
//   flowSize = lambdaHat * sizeHat
//   fBase = BASE_FEE + SIGMA_COEF*sigmaHat + LAMBDA_COEF*lambdaHat + FLOW_SIZE_COEF*flowSize
```

### B. Tail compression

```text
function _compressTailWithSlope(fee, slope) {
  if (fee <= TAIL_KNEE) return fee;
  return TAIL_KNEE + (fee - TAIL_KNEE) * slope;  // WAD mult
}
// After computing bidFee, askFee (with protect/attract sides known):
// bidFee = clamp(_compressTailWithSlope(bidFee, TAIL_SLOPE_PROTECT or TAIL_SLOPE_ATTRACT))
// askFee = clamp(_compressTailWithSlope(askFee, ...))
```

### C. First-in-step pHat/sigma

```text
firstInStep = (timestamp > lastTs) or (stepTradeCount == 0 after reset)
alpha = firstInStep ? PHAT_ALPHA : PHAT_ALPHA_RETAIL
if (ret <= gate) pHat = (1-alpha)*pHat + alpha*pImplied
if (firstInStep) sigmaHat = SIGMA_DECAY*sigmaHat + (1-SIGMA_DECAY)*ret
```

### D. Lower base, additive (conceptual)

```text
// Replace: rawFee = BASE_FEE * (1+K_VOL*vol)*(1+K_IMB*imb) + symTox + floor
// With:    fBase = BASE_FEE_LOW + SIGMA_COEF*sigmaHat + IMB_COEF*imbalance + VOL_COEF*vol
//         fBase += symTox; then floor as needed
// Tune BASE_FEE_LOW (e.g. 5e14) and coefs so calm-regime fee ~ 25–35 bps.
```

---

## Step 7 — Simulation Blueprint

- **Inputs:** Same harness, 1000 sims; same or varied seeds for comparability.
- **Metrics:**  
  - Edge (primary).  
  - Fee distribution (mean, p90, cap-hit rate) by side (bid/ask).  
  - Retail vs arb edge (if harness reports).  
  - By regime: calm (low sigma/tox) vs active vs high-tox.
- **Scenarios:**  
  1. V9 vs V7 vs V8 (confirm regression and V9 direction).  
  2. V9 + cap 85 only; V9 + dirState only; V9 + stale+attract only (isolate V8 levers).  
  3. New variant: V7 or V9 + **tail compression** (same cap, no other new state).  
  4. New variant: + **lambdaHat + sizeHat** (and flowSize in base) with minimal constants.  
  5. New variant: + **first-in-step** pHat/sigma (if stepTradeCount added).  
  6. (Later) Lower-base additive structure vs current multiplicative.
- **Criteria:** Edge ≥ 400 as first milestone; then approach 450+; compare to YQ (520) to see remaining gap.

---

## Step 8 — Recommendation

### Do we need big structural changes?

- **Parameter-only:** Unlikely to close a 146-point gap. V8 already added many YQ ideas and regressed; tuning alone (e.g. V9) may at best restore ~380.
- **At least one structural change** is likely needed. The most evidence-backed are:
  1. **Activity/flow in base** (lambdaHat, sizeHat, flowSize) — YQ has it; we don’t; research supports flow-sensitive fees.  
  2. **Tail compression** — YQ uses it; we use a hard cap; it directly addresses cap clipping.  
  3. **First-in-step pHat/sigma** — YQ uses it; we update every trade; it reduces noise and exploitability in multi-trade steps.

### Suggested order of work

1. **Confirm V9**  
   Run V9; if edge ≥ 380, we’ve isolated the regression to cap 85 and/or stale+attract and/or dirState skew. Then re-enable one lever at a time and measure.

2. **Add tail compression (V10)**  
   Keep V9 logic (or V7 if preferred baseline). Replace hard cap with tail compression (knee 5 bps, slopes 0.93 / 0.955), then clamp. No new slots. Low risk, high information value.

3. **Add activity/flow (V11)**  
   Add lambdaHat, stepTradeCount, sizeHat; on new step update lambda and decay sizeHat; in base add LAMBDA_COEF×lambdaHat and FLOW_SIZE_COEF×lambdaHat×sizeHat. Tune constants small at first. This is the biggest structural add.

4. **Add first-in-step pHat/sigma (V12 or same as V11)**  
   If we already have stepTradeCount for lambda, use it for firstInStep and dual alpha + sigma-only-on-first. Tune PHAT_ALPHA_RETAIL to be slow (e.g. 0.05).

5. **Consider lower base + additive (later)**  
   If edge is still far from 500+, try a variant with BASE_FEE ~ 5–15 bps and additive sigma/imb/vol terms to mimic YQ’s build-up and threshold-type behavior.

### Documentation

- Keep this audit in `/docs` and update with V9/V10 results.  
- Log each version in a changelog (e.g. `2025-02-09-Sapient-V10-changelog.md`) and design notes in `/docs` per workspace rules.

---

## Summary Table

| Cause we're stuck / gap to 526     | Fix (structural vs tune)        |
|-----------------------------------|----------------------------------|
| V8 regression                     | V9 isolate; re-enable one lever  |
| No activity/flow in base          | lambdaHat, sizeHat, flowSize    |
| Hard cap clips margin             | Tail compression                |
| pHat/sigma every trade            | First-in-step alpha + sigma     |
| Base too high in calm             | Lower base, additive terms (later) |
| Research: two regimes, linear inv | Threshold-type + inventory sensitivity |

---

## References

- [Optimal Dynamic Fees in Automated Market Makers](https://arxiv.org/html/2506.02869v1) — Baggiani, Herdegen, Sánchez-Betancourt; two fee regimes, linear-in-inventory approximation.
- [2025-02-09-Sapient-V7-under-400-analysis.md](2025-02-09-Sapient-V7-under-400-analysis.md) — V7 diagnosis and V8 recommendation.
- [2025-02-09-YQ-extract-for-Sapient.md](2025-02-09-YQ-extract-for-Sapient.md) — YQ concepts (lambda, sizeHat, tail compression, first-in-step).
- [YQ_STRATEGY_EXPLAINED.md](YQ_STRATEGY_EXPLAINED.md) — YQ strategy in plain language.
- [amm-challenge/README.md](../amm-challenge/README.md) — Edge definition, simulation, normalizer.

---

## Changelog

- **2025-02-09:** Initial audit: diagnosis (V8 regression, no activity/flow, hard cap, single alpha, high base); exploit vectors; failure modes; research summary; ideas A–F; formulas; simulation plan; recommendation (structural changes: tail compression, activity/flow, first-in-step; then lower base if needed).
